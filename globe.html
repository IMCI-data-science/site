<!DOCTYPE html>
<html>
<head>
    <title>Joe Faddoul - Global Activities</title>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="index.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/d3-dsv.v3.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        #container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #000;
        }
        
        #header {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
        }
        
        #globe-container {
            position: relative;
        }
        
        canvas {
            cursor: grab;
        }
        
        canvas:active {
            cursor: grabbing;
        }
        
        .country {
            fill: #0f0;
            stroke: #000;
            stroke-width: 0.5;
        }
        
        .pin {
            fill: #ff0096;
            stroke: #0bc;
            stroke-width: 2;
        }
        
        .pin-label {
            fill: #0bc;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            pointer-events: none;
        }
        
        #info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.9);
            border: 2px solid #0f0;
            padding: 15px;
            max-width: 350px;
            display: none;
            z-index: 100;
        }
        
        #info-panel h3 {
            color: #0bc;
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        
        #info-panel p {
            color: #fff;
            margin: 5px 0;
            font-size: 13px;
            line-height: 1.5;
        }
        
        #legend {
            display: none;
        }
        
        #back-link {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }
        
        #back-link a {
            color: #0bc;
            text-decoration: none;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        #back-link a:hover {
            color: #0f0;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="header">
            <div style="margin-bottom: 10px;">
                <span style="color: #0bc;">jjfaddoul@portfolio</span>:<span style="color: #fff;">~</span><span style="color: #0f0;">$</span> globe --interactive
            </div>
            <h1 style="color: #0f0; font-size: 24px; margin: 0;">GLOBAL ACTIVITIES MAP</h1>
            <div style="color: #888; font-size: 12px; margin-top: 5px;">
                Drag to rotate • Scroll to zoom • Click pins for details
            </div>
        </div>
        

        
        <div id="globe-container">
            <svg id="globe"></svg>
        </div>
        
        <div id="info-panel"></div>
        
        <div id="back-link">
            <a href="index.html">← Back to Terminal</a>
        </div>
    </div>

    <script>
        // Globe configuration
        const width = Math.min(window.innerWidth * 0.8, 800);
        const height = Math.min(window.innerHeight * 0.8, 800);
        const sensitivity = 75;

        // Location coordinates mapping - populated from CSV
        const locationCoords = {
            "Myoko, Japan": [138.25, 37.0333],
            "Christchurch, New Zealand": [172.639847, -43.525650],
            "Glasgow, UK": [-4.251433, 55.860916],
            "Rwanda": [30.0318, -1.985],
            "Uganda": [32.5825, 0.34759],
            "Tanzania": [39.1783, -6.776],
            "Tours, France": [0.6892, 47.2435],
            "Singapore, Singapore": [103.85, 1.289],
            "Cambridge, UK": [0.119167, 52.205276],
            "Manchester, UK": [-2.2446, 53.483959],
            "Toronto, Canada": [-79.347015, 43.65107],
            "Round Rock, USA": [-97.6789, 30.5083],
            "Jakarta, Indonesia": [106.81666, -6.2],
            "Beirut, Lebanon": [35.49548, 33.88863],
            "Dublin, Ireland": [-6.26615, 53.35014]
        };

        let activities = [];

        // Create SVG
        const svg = d3.select("#globe")
            .attr("width", width)
            .attr("height", height);

        // Create projection
        const projection = d3.geoOrthographic()
            .scale(Math.min(width, height) / 2.2)
            .center([0, 0])
            .rotate([0, -30])
            .translate([width / 2, height / 2]);

        const initialScale = projection.scale();
        const path = d3.geoPath().projection(projection);

        // Create globe background
        svg.append("circle")
            .attr("fill", "#000")
            .attr("stroke", "#0f0")
            .attr("stroke-width", "2")
            .attr("cx", width / 2)
            .attr("cy", height / 2)
            .attr("r", initialScale);

        // Create groups
        const g = svg.append("g");
        const pinGroup = svg.append("g");

        // Load CSV data and convert to activities
        d3.csv("www/plot_details.csv").then(data => {
            activities = data.map(row => {
                const coords = locationCoords[row.Location];
                if (!coords) {
                    console.warn(`No coordinates found for location: ${row.Location}`);
                    return null;
                }
                return {
                    coords: coords,
                    name: row.Location,
                    title: row.Title,
                    description: row.Description,
                    year: row.Year
                };
            }).filter(activity => activity !== null);

            console.log(`Loaded ${activities.length} activities from CSV`);

            // Load and render world map
            d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json").then(world => {
                const countries = topojson.feature(world, world.objects.countries);
                
                g.selectAll("path")
                    .data(countries.features)
                    .enter().append("path")
                    .attr("class", "country")
                    .attr("d", path)
                    .style("fill", "#0f0")
                    .style("stroke", "#000")
                    .style("stroke-width", "0.5")
                    .style("opacity", 0.3);

                // Render pins
                renderPins();
            });
        }).catch(error => {
            console.error("Error loading CSV:", error);
        });

        function renderPins() {
            pinGroup.selectAll(".pin-group").remove();

            // Group activities by location
            const locationGroups = d3.group(activities, d => d.name);

            locationGroups.forEach((activitiesAtLocation, locationName) => {
                const activity = activitiesAtLocation[0]; // Get first activity for coordinates
                const coords = projection(activity.coords);
                const count = activitiesAtLocation.length;
                
                if (coords) {
                    const distance = d3.geoDistance(
                        activity.coords,
                        projection.invert([width / 2, height / 2])
                    );
                    
                    // Only show pins on the visible side of the globe
                    if (distance < Math.PI / 2) {
                        const pinG = pinGroup.append("g")
                            .attr("class", "pin-group")
                            .style("cursor", "pointer");

                        // Pin pulse animation
                        const pulse = pinG.append("circle")
                            .attr("cx", coords[0])
                            .attr("cy", coords[1])
                            .attr("r", 8)
                            .attr("fill", "#0f0")
                            .attr("opacity", 0.3);

                        pulse.append("animate")
                            .attr("attributeName", "r")
                            .attr("from", "8")
                            .attr("to", "15")
                            .attr("dur", "2s")
                            .attr("repeatCount", "indefinite");

                        pulse.append("animate")
                            .attr("attributeName", "opacity")
                            .attr("from", "0.3")
                            .attr("to", "0")
                            .attr("dur", "2s")
                            .attr("repeatCount", "indefinite");

                        // Main pin
                        const pinRadius = 5;
                        pinG.append("circle")
                            .attr("cx", coords[0])
                            .attr("cy", coords[1])
                            .attr("r", pinRadius)
                            .attr("fill", "#0f0")
                            .attr("stroke", "#0bc")
                            .attr("stroke-width", 2);

                        // Click handler - show all activities at this location
                        pinG.on("click", function(event) {
                            event.stopPropagation();
                            showInfoMultiple(activitiesAtLocation);
                        });

                        pinG.on("mouseenter", function() {
                            d3.select(this).selectAll("circle")
                                .filter(function(d, i) { return i === 1; }) // Main pin only
                                .transition()
                                .attr("r", pinRadius + 2);
                        });

                        pinG.on("mouseleave", function() {
                            d3.select(this).selectAll("circle")
                                .filter(function(d, i) { return i === 1; })
                                .transition()
                                .attr("r", pinRadius);
                        });
                    }
                }
            });
        }

        function showInfoMultiple(activitiesAtLocation) {
            const panel = d3.select("#info-panel");
            
            let html = `<h3 style="color: #0f0; font-size: 18px;">${activitiesAtLocation[0].name}</h3>`;
            html += `<p style="color: #888; font-size: 13px; margin-bottom: 10px;">${activitiesAtLocation.length} ${activitiesAtLocation.length === 1 ? 'activity' : 'activities'} at this location</p>`;
            
            activitiesAtLocation.forEach((activity, index) => {
                if (index > 0) html += '<hr style="border-color: #0f0; margin: 10px 0;">';
                html += `
                    <div style="margin-bottom: 8px;">
                        <h4 style="color: #0bc; margin: 0 0 5px 0; font-size: 16px;">${activity.title}</h4>
                        <p style="margin: 3px 0; font-size: 14px;">${activity.description}</p>
                    </div>
                `;
            });
            
            panel.html(html);
            panel.style("display", "block");
        }

        // Hide info panel when clicking on globe
        svg.on("click", function() {
            d3.select("#info-panel").style("display", "none");
        });

        // Drag behavior
        let isDragging = false;
        
        svg.call(d3.drag()
            .on("start", function() {
                isDragging = true;
            })
            .on("drag", function(event) {
                const rotate = projection.rotate();
                const k = sensitivity / projection.scale();
                projection.rotate([
                    rotate[0] + event.dx * k,
                    rotate[1] - event.dy * k
                ]);
                
                g.selectAll("path").attr("d", path);
                renderPins();
            })
            .on("end", function() {
                setTimeout(() => {
                    isDragging = false;
                }, 100);
            })
        );

        // Zoom behavior
        svg.call(d3.zoom()
            .scaleExtent([0.5, 5])
            .on("zoom", function(event) {
                if (event.sourceEvent && event.sourceEvent.type === "wheel") {
                    const newScale = initialScale * event.transform.k;
                    projection.scale(newScale);
                    
                    // Update globe background circle
                    svg.select("circle")
                        .attr("r", newScale);
                    
                    g.selectAll("path").attr("d", path);
                    renderPins();
                }
            })
        );

        // Auto-rotate globe slowly
        let autoRotate = true;
        d3.timer(function(elapsed) {
            if (!isDragging && autoRotate) {
                const rotate = projection.rotate();
                projection.rotate([rotate[0] + 0.1, rotate[1]]);
                g.selectAll("path").attr("d", path);
                renderPins();
            }
        });

        // Pause auto-rotate on hover
        svg.on("mouseenter", function() {
            autoRotate = false;
        });

        svg.on("mouseleave", function() {
            if (!isDragging) {
                setTimeout(() => {
                    autoRotate = true;
                }, 1000);
            }
        });

        // Handle window resize
        window.addEventListener('resize', function() {
            location.reload();
        });
    </script>
</body>
</html>
